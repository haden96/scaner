<!DOCTYPE html>
<html lang="pl">

<head>
  <meta charset="UTF-8" />
  <title>Tabela ZakÅ‚adÃ³w</title>

  <!-- Tailwind -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">

  <!-- Tablesort -->
  <script src="https://cdn.jsdelivr.net/npm/tablesort@5.2.1/dist/tablesort.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tablesort@5.2.1/dist/sorts/tablesort.number.min.js"></script>

  <meta name="robots" content="noindex, nofollow">
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    #bettingTable {
      border-collapse: separate;
      border-spacing: 0;
    }

    thead th {
      position: sticky;
      top: 0;
      z-index: 1000;
      background-color: #e5e7eb;
      /* bg-gray-200 */
    }

    body.dark thead th {
      background-color: #020617;
    }


    tr.highlight {
      background-color: #ecfff3;
    }

    /* PODÅšWIETLENIE VALUE (6. kolumna staÅ‚a) */
    table tr>*:nth-child(6) {
      background-color: #e0f2fe;
      color: #1e3a8a;
    }

    body.dark {
      background-color: #0f172a;
      color: #e5e7eb;
    }

    body.dark .bg-white {
      background-color: #020617;
    }

    body.dark .bg-gray-100 {
      background-color: #0f172a;
    }

    body.dark .bg-gray-200 {
      background-color: #020617;
    }

    body.dark th,
    body.dark td {
      border-color: #1e293b;
    }

    body.dark input,
    body.dark select {
      background-color: #020617;
      color: #e5e7eb;
      border-color: #334155;
    }

    body.dark button {
      background-color: #1e293b;
      color: #e5e7eb;
    }

    /* VALUE w dark mode */
    body.dark table tr>*:nth-child(6) {
      background-color: #082f49;
      color: #7dd3fc;
    }

    /* przycisk usuÅ„ */
    .btn-del {
      background: transparent;
      padding: 0.1rem 0.35rem;
      border-radius: 0.375rem;
    }

    .btn-del:hover {
      background: rgba(239, 68, 68, 0.12);
    }
  </style>
</head>

<body class="p-6 bg-gray-100">
  <div class="max-w-7xl mx-auto">
    <h1 class="text-xl font-bold mb-4">Dane bukmacherskie</h1>
    <div class="text-sm text-gray-600 mb-3">
      Ostatnia aktualizacja: <span id="lastUpdate">â€”</span>
    </div>
    <!-- Panel sterowania -->
    <div class="bg-white p-4 shadow rounded mb-4 grid grid-cols-1 md:grid-cols-2 gap-3">
      <div class="flex items-center flex-wrap gap-2">
        <label class="font-medium">Filtruj:</label>
        <select id="filterType" class="border p-2 rounded">
          <option value="diff">Diff</option>
          <option value="weighted_sum">Value</option>
        </select>
        <input type="number" id="minValue" step="0.01" inputmode="decimal" placeholder="Min wartoÅ›Ä‡"
          class="border p-2 rounded w-40">
        <button id="btnFilter" class="px-3 py-2 bg-blue-600 text-white rounded">Filtruj</button>
        <button id="btnReset" class="px-3 py-2 bg-gray-300 rounded">Reset</button>
      </div>

      <div class="flex items-center flex-wrap gap-2">
        <label for="searchBox" class="font-medium">Szukaj:</label>
        <input id="searchBox" type="text" placeholder="Mecz/rynek/opis..."
          class="border p-2 rounded flex-1 min-w-[220px]" />
        <span id="rowCount" class="text-sm text-gray-500 ml-auto"></span>
      </div>
    </div>

    <div class="flex items-center gap-2 mb-3">
      <input type="checkbox" id="hideYellowCards" class="h-4 w-4">
      <label for="hideYellowCards" class="text-sm font-medium">Ukryj Yellow Cards</label>

      <div class="ml-auto flex items-center gap-2">
        <button id="darkToggle" class="px-4 py-2 rounded bg-gray-800 text-white">ğŸŒ™ Tryb nocny</button>
      </div>
    </div>

    <div class="flex items-center gap-2 mb-3 flex-wrap">
      <div class="flex items-center gap-2">
        <label class="text-sm font-medium">Filtr kursÃ³w (kolumna Odds):</label>
        <select id="oddsCondition" class="border p-2 rounded">
          <option value="">-- wybierz --</option>
          <option value="above">PowyÅ¼ej</option>
          <option value="below">PoniÅ¼ej</option>
        </select>
        <input type="number" id="oddsValue" step="0.01" inputmode="decimal" placeholder="Kurs"
          class="border p-2 rounded w-28">
      </div>
    </div>

    <!-- Bukmacherzy: filtr wierszy po best_bk + zapamiÄ™tanie -->
    <div class="bg-white p-4 shadow rounded mb-4">
      <div class="flex items-center gap-3 flex-wrap">
        <span class="text-sm font-medium">PokaÅ¼ tylko wiersze, gdzie najlepszy bukmacher to:</span>
        <button id="bkAll" class="px-3 py-1 rounded bg-gray-200 text-sm">Zaznacz wszystko</button>
        <button id="bkNone" class="px-3 py-1 rounded bg-gray-200 text-sm">Odznacz wszystko</button>
        <button id="bkRestoreDeleted" class="px-3 py-1 rounded bg-gray-200 text-sm ml-auto">PrzywrÃ³Ä‡ usuniÄ™te</button>
        <span class="text-xs text-gray-500" id="bkHint"></span>
      </div>
      <div id="bkList" class="mt-3 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-2"></div>
      <div class="text-xs text-gray-500 mt-2">
        Checkboxy filtrujÄ… WIERSZE po kolumnie â€Najlepszy bukmacherâ€. WybÃ³r jest zapisywany w przeglÄ…darce
        (localStorage).
        UsuniÄ™te rekordy teÅ¼ sÄ… zapamiÄ™tane.
      </div>
    </div>

    <!-- Tabela -->
    <div class="table-wrap bg-white shadow rounded">
      <table class="table-auto w-full" id="bettingTable" aria-describedby="rowCount">
        <thead class="bg-gray-200">
          <tr id="tableHeadRow">
            <th class="text-left p-2">Mecz</th>
            <th class="text-left p-2">Rynek</th>
            <th class="text-left p-2">Opis</th>
            <th class="text-right p-2" data-sort-method="number">Odds</th>
            <th class="text-right p-2" data-sort-method="number">Diff</th>
            <th class="text-right p-2" data-sort-method="number">Value</th>
            <th class="text-right p-2" data-sort-method="number">Value New</th>
            <th class="text-left p-2" data-sort-method="string">Najlepszy bukmacher</th>
            <!-- bukmacherzy dopisze JS -->
            <th class="text-center p-2" data-sort-method="none">UsuÅ„</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const table = document.getElementById('bettingTable');
      const tbody = document.getElementById('tableBody');
      const headRow = document.getElementById('tableHeadRow');

      const filterTypeEl = document.getElementById('filterType');
      const minValueEl = document.getElementById('minValue');
      const btnFilter = document.getElementById('btnFilter');
      const btnReset = document.getElementById('btnReset');
      const searchBox = document.getElementById('searchBox');
      const rowCount = document.getElementById('rowCount');

      const hideYellowCardsEl = document.getElementById('hideYellowCards');
      const oddsConditionEl = document.getElementById('oddsCondition');
      const oddsValueEl = document.getElementById('oddsValue');

      const bkList = document.getElementById('bkList');
      const bkAll = document.getElementById('bkAll');
      const bkNone = document.getElementById('bkNone');
      const bkHint = document.getElementById('bkHint');
      const bkRestoreDeleted = document.getElementById('bkRestoreDeleted');

      const LS_KEY = "bestbk_filter_selected_v1";
      const DELETED_KEY = "deleted_rows_v1";

      let allBookmakers = [];
      let selectedBestBK = new Set();   // best_bk zaznaczone (filtr)
      let deletedRows = new Set();      // id usuniÄ™te

      // trzymamy dane w pamiÄ™ci, Å¼eby mÃ³c re-renderowaÄ‡ po "przywrÃ³Ä‡"
      let currentData = null;
      let sorter = null;

      // --- utils ---
      const toNumFromCell = (el) => {
        if (!el) return NaN;
        const s = (el.dataset.value ?? el.textContent ?? '').toString().replace(',', '.').trim();
        const n = parseFloat(s);
        return Number.isFinite(n) ? n : NaN;
      };

      const fmt2 = (x) => Number.isFinite(x) ? x.toFixed(2) : '';

      function loadSelectedBestBK(defaultList) {
        try {
          const raw = localStorage.getItem(LS_KEY);
          if (!raw) return new Set(defaultList); // domyÅ›lnie wszystko zaznaczone
          const arr = JSON.parse(raw);
          if (!Array.isArray(arr)) return new Set(defaultList);
          return new Set(arr.filter(x => defaultList.includes(x)));
        } catch {
          return new Set(defaultList);
        }
      }

      function saveSelectedBestBK() {
        localStorage.setItem(LS_KEY, JSON.stringify([...selectedBestBK]));
      }

      function loadDeletedRows() {
        try {
          const raw = localStorage.getItem(DELETED_KEY);
          if (!raw) return new Set();
          const arr = JSON.parse(raw);
          if (!Array.isArray(arr)) return new Set();
          return new Set(arr.map(String));
        } catch {
          return new Set();
        }
      }

      function saveDeletedRows() {
        localStorage.setItem(DELETED_KEY, JSON.stringify([...deletedRows]));
      }

      function updateBKHint() {
        bkHint.textContent = `Wybrane: ${selectedBestBK.size}/${allBookmakers.length} | UsuniÄ™te: ${deletedRows.size}`;
      }

      function renderBookmakerCheckboxes(bookmakers) {
        bkList.textContent = "";
        const frag = document.createDocumentFragment();

        for (const bk of bookmakers) {
          const label = document.createElement("label");
          label.className = "flex items-center gap-2 text-sm";

          const cb = document.createElement("input");
          cb.type = "checkbox";
          cb.className = "h-4 w-4";
          cb.checked = selectedBestBK.has(bk);

          cb.addEventListener("change", () => {
            if (cb.checked) selectedBestBK.add(bk);
            else selectedBestBK.delete(bk);

            saveSelectedBestBK();
            updateBKHint();
            applyFilter();
          });

          const span = document.createElement("span");
          span.textContent = bk;

          label.append(cb, span);
          frag.appendChild(label);
        }

        bkList.appendChild(frag);
        updateBKHint();
      }

      function renderTable({ rows, bookmakers }) {
        // usuÅ„ poprzednie nagÅ‚Ã³wki bukmacherÃ³w (zostaw: 7 staÅ‚ych + ostatnia "UsuÅ„" = razem 8)
        // W thead mamy: 7 staÅ‚ych, potem dynamiczne bk, potem "UsuÅ„".
        // Czyli dynamiczne sÄ… miÄ™dzy indeksem 7 a (len-2).
        // NajproÅ›ciej: usuÅ„ wszystko miÄ™dzy staÅ‚ymi a ostatniÄ… kolumnÄ….
        while (headRow.cells.length > 10) headRow.deleteCell(9);

        // wstaw nagÅ‚Ã³wki bukmacherÃ³w PRZED ostatniÄ… kolumnÄ… ("UsuÅ„")
        const deleteTh = headRow.lastElementChild;
        for (const bk of bookmakers) {
          const th = document.createElement("th");
          th.className = "text-right p-2";
          th.setAttribute("data-sort-method", "number");
          th.textContent = bk;
          headRow.insertBefore(th, deleteTh);
        }

        const frag = document.createDocumentFragment();

        for (const row of rows) {
          // wymagamy id - jeÅ›li brak, to ten rekord jest bezuÅ¼yteczny do usuwania
          const rid = String(row.id ?? "");
          if (!rid) continue;

          // pomiÅ„ usuniÄ™te
          if (deletedRows.has(rid)) continue;

          const tr = document.createElement("tr");
          tr.className = "border-t";
          tr.dataset.id = rid;

          const tdMatch = document.createElement("td");
          tdMatch.className = "p-2";
          tdMatch.textContent = row.match;

          const tdMarket = document.createElement("td");
          tdMarket.className = "p-2";
          tdMarket.textContent = row.market;

          const tdDesc = document.createElement("td");
          tdDesc.className = "p-2";
          tdDesc.textContent = row.description;

          const tdBestOdds = document.createElement("td");
          tdBestOdds.className = "text-right p-2";
          tdBestOdds.dataset.col = "odds";
          tdBestOdds.dataset.value = Number.isFinite(row.best_odds) ? String(row.best_odds) : "";
          tdBestOdds.textContent = fmt2(row.best_odds);

          const tdDiff = document.createElement("td");
          tdDiff.className = "text-right p-2";
          tdDiff.dataset.col = "diff";
          tdDiff.dataset.value = Number.isFinite(row.diff) ? String(row.diff) : "";
          tdDiff.textContent = fmt2(row.diff);

          const tdVal = document.createElement("td");
          tdVal.className = "text-right p-2";
          tdVal.dataset.col = "value";
          tdVal.dataset.value = Number.isFinite(row.value) ? String(row.value) : "";
          tdVal.textContent = fmt2(row.value);

          const tdValNew = document.createElement("td");
          tdValNew.className = "text-right p-2";
          tdValNew.dataset.col = "value_new";
          tdValNew.dataset.value = Number.isFinite(row.value_new) ? String(row.value_new) : "";
          tdValNew.textContent = fmt2(row.value_new);

          const tdBest = document.createElement("td");
          tdBest.className = "p-2";
          tdBest.dataset.col = "best_bk";
          tdBest.textContent = row.best_bk ?? "";

          // staÅ‚e kolumny
          tr.append(tdMatch, tdMarket, tdDesc, tdBestOdds, tdDiff, tdVal, tdValNew, tdBest);

          // kolumny bukmacherÃ³w
          for (const bk of bookmakers) {
            const td = document.createElement("td");
            td.className = "text-right p-2";
            const v = row.odds?.[bk];
            td.dataset.value = Number.isFinite(v) ? String(v) : "";
            td.textContent = fmt2(v);
            tr.appendChild(td);
          }

          // kolumna usuÅ„
          const tdDelete = document.createElement("td");
          tdDelete.className = "text-center p-2";

          const btnDel = document.createElement("button");
          btnDel.type = "button";
          btnDel.title = "UsuÅ„ rekord";
          btnDel.className = "btn-del text-red-600 hover:text-red-800 text-lg";
          btnDel.textContent = "âœ–";

          btnDel.addEventListener("click", () => {
            const bestBk = (row.best_bk ?? "").toString().trim();
            const desc = (row.description ?? "").toString().trim();
            const m = (row.match ?? "").toString().trim();

            const ok = confirm(`UsunÄ…Ä‡ rekord?\n\n${m}\n${bestBk} | ${desc}`);
            if (!ok) return;

            deletedRows.add(rid);
            saveDeletedRows();
            tr.remove();
            updateBKHint();
            applyFilter();
          });

          tdDelete.appendChild(btnDel);
          tr.appendChild(tdDelete);

          frag.appendChild(tr);
        }

        tbody.textContent = "";
        tbody.appendChild(frag);
      }

      function applyFilter() {
        const type = filterTypeEl.value;
        const minRaw = (minValueEl.value ?? '').trim();
        const min = minRaw === '' ? -Infinity : parseFloat(minRaw.replace(',', '.'));
        const term = (searchBox.value ?? '').trim().toLowerCase();
        const hideYellow = hideYellowCardsEl.checked;

        const oddsCondition = oddsConditionEl.value;
        const oddsRaw = (oddsValueEl.value ?? '').trim();
        const oddsVal = oddsRaw === '' ? NaN : parseFloat(oddsRaw.replace(',', '.'));

        let visible = 0;

        table.querySelectorAll('tbody tr').forEach(row => {
          const valCell = row.querySelector(type === 'diff' ? 'td[data-col="diff"]' : 'td[data-col="value"]');
          const val = toNumFromCell(valCell);

          const passVal = (min === -Infinity) || (Number.isFinite(val) && val >= min);
          const textMatch = term === '' || row.textContent.toLowerCase().includes(term);
          const notYellow = !hideYellow || !row.textContent.toLowerCase().includes('yellow card');

          // filtr kursÃ³w po kolumnie Odds (= best_odds)
          let passOdds = true;
          if (!isNaN(oddsVal) && oddsCondition) {
            const odds = toNumFromCell(row.querySelector('td[data-col="odds"]'));
            if (!Number.isFinite(odds)) {
              passOdds = false;
            } else {
              passOdds = oddsCondition === "above" ? (odds > oddsVal) : (odds < oddsVal);
            }
          }

          // filtr po "Najlepszy bukmacher"
          const bestBk = (row.querySelector('td[data-col="best_bk"]')?.textContent ?? "").trim();
          const passBestBk = selectedBestBK.size === 0 ? true : selectedBestBK.has(bestBk);

          if (passVal && textMatch && notYellow && passOdds && passBestBk) {
            row.style.display = '';
            visible++;
          } else {
            row.style.display = 'none';
          }
        });

        rowCount.textContent = `${visible} wynikÃ³w`;

        if (sorter) sorter.refresh();
      }

      function fullRerender() {
        if (!currentData) return;
        renderTable(currentData);
        if (sorter) sorter.refresh();
        applyFilter();
        updateBKHint();
      }

      // --- init ---
      try {
        const res = await fetch("frontend.json?v=" + Date.now(), { cache: "no-store" });
        const data = await res.json();
        currentData = data;
        const lastUpdateEl = document.getElementById("lastUpdate");

        function formatPL(iso) {
          const d = new Date(iso);
          if (isNaN(d.getTime())) return "â€”";
          return new Intl.DateTimeFormat("pl-PL", {
            year: "numeric",
            month: "2-digit",
            day: "2-digit",
            hour: "2-digit",
            minute: "2-digit",
            second: "2-digit",
          }).format(d);
        }

        if (lastUpdateEl) {
          lastUpdateEl.textContent = data.generated_at ? formatPL(data.generated_at) : "â€”";
        }

        allBookmakers = data.bookmakers ?? [];

        deletedRows = loadDeletedRows();
        selectedBestBK = loadSelectedBestBK(allBookmakers);

        renderBookmakerCheckboxes(allBookmakers);
        renderTable(data);

        sorter = new Tablesort(table);
        sorter.refresh();

        applyFilter();
        updateBKHint();
      } catch (e) {
        tbody.innerHTML = `<tr><td class="p-3 text-red-600" colspan="99">BÅ‚Ä…d Å‚adowania JSON: ${e.message}</td></tr>`;
      }

      // --- events ---
      btnFilter.addEventListener('click', applyFilter);

      btnReset.addEventListener('click', () => {
        minValueEl.value = '';
        searchBox.value = '';
        oddsConditionEl.value = '';
        oddsValueEl.value = '';
        hideYellowCardsEl.checked = false;

        // NIE resetujemy checkboxÃ³w bukmacherÃ³w ani usuniÄ™tych - majÄ… siÄ™ pamiÄ™taÄ‡
        applyFilter();
      });

      searchBox.addEventListener('input', applyFilter);
      minValueEl.addEventListener('keydown', (e) => { if (e.key === 'Enter') applyFilter(); });
      searchBox.addEventListener('keydown', (e) => { if (e.key === 'Enter') applyFilter(); });

      hideYellowCardsEl.addEventListener('change', applyFilter);
      oddsConditionEl.addEventListener('change', applyFilter);
      oddsValueEl.addEventListener('input', applyFilter);
      oddsValueEl.addEventListener('keydown', (e) => { if (e.key === 'Enter') applyFilter(); });

      bkAll.addEventListener("click", () => {
        selectedBestBK = new Set(allBookmakers);
        saveSelectedBestBK();
        bkList.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
        updateBKHint();
        applyFilter();
      });

      bkNone.addEventListener("click", () => {
        selectedBestBK = new Set();
        saveSelectedBestBK();
        bkList.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
        updateBKHint();
        applyFilter();
      });

      bkRestoreDeleted.addEventListener("click", () => {
        const ok = confirm("PrzywrÃ³ciÄ‡ WSZYSTKIE usuniÄ™te rekordy? (wyczyÅ›ci localStorage)");
        if (!ok) return;
        deletedRows = new Set();
        localStorage.removeItem(DELETED_KEY);
        fullRerender();
      });

      // dark mode
      const darkToggle = document.getElementById('darkToggle');
      if (localStorage.getItem('darkMode') === '1') {
        document.body.classList.add('dark');
        darkToggle.textContent = 'â˜€ï¸ Tryb jasny';
      }
      darkToggle.addEventListener('click', () => {
        document.body.classList.toggle('dark');
        const isDark = document.body.classList.contains('dark');
        localStorage.setItem('darkMode', isDark ? '1' : '0');
        darkToggle.textContent = isDark ? 'â˜€ï¸ Tryb jasny' : 'ğŸŒ™ Tryb nocny';
      });
    });
  </script>
</body>

</html>